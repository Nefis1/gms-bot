<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-warning">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-industry"></i> Производственная система
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <h1><i class="fas fa-cogs"></i> Панель администратора</h1>
        
        <div class="row mt-4">
            <!-- Очистка тикетов -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle"></i> Очистка тикетов</h5>
                    </div>
                    <div class="card-body">
                        <p>Всего тикетов в системе: <strong>{{ total_tickets }}</strong></p>
                        <div class="mb-3">
                            <label for="password" class="form-label">Пароль для подтверждения:</label>
                            <input type="password" class="form-control" id="password" placeholder="Введите пароль">
                        </div>
                        <button onclick="clearTickets()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Очистить все тикеты
                        </button>
                        <div id="clearResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Резервное копирование -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-database"></i> Управление данными</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button onclick="createBackup()" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-save"></i> Создать backup
                            </button>
                            <div id="backupResult" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="ticketId" class="form-label">Закрыть тикет (ID):</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="ticketId" placeholder="TK0001">
                                <button onclick="closeTicket()" class="btn btn-warning">Закрыть</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список активных тикетов -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-list"></i> Активные тикеты</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Миксер</th>
                                        <th>Продукт</th>
                                        <th>Статус</th>
                                        <th>Создан</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ticket in active_tickets %}
                                    <tr>
                                        <td><strong>{{ ticket.ticket_id }}</strong></td>
                                        <td>{{ ticket.mixer }}</td>
                                        <td>{{ ticket.product }}</td>
                                        <td>
                                            <span class="badge bg-{% if ticket.status == 'completed' %}success{% else %}warning{% endif %}">
                                                {{ ticket.status }}
                                            </span>
                                        </td>
                                        <td>{{ ticket.created_at[:16] }}</td>
                                        <td>
                                            <button onclick="closeSpecificTicket('{{ ticket.ticket_id }}')" 
                                                    class="btn btn-sm btn-outline-danger">
                                                Закрыть
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад к панели
            </a>
        </div>
    </div>

    <script>
        function clearTickets() {
            const password = document.getElementById('password').value;
            if (!password) {
                alert('Введите пароль');
                return;
            }
            
            if (!confirm('ВЫ УВЕРЕНЫ? Это действие нельзя отменить! Все тикеты будут удалены.')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('password', password);
            
            fetch('/admin/clear_tickets', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('clearResult');
                if (data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    setTimeout(() => window.location.href = '/', 2000);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('clearResult').innerHTML = 
                    `<div class="alert alert-danger">Ошибка: ${error}</div>`;
            });
        }
        
        function createBackup() {
            fetch('/admin/backup', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('backupResult');
                if (data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            });
        }
        
        function closeTicket() {
            const ticketId = document.getElementById('ticketId').value;
            if (!ticketId) {
                alert('Введите ID тикета');
                return;
            }
            
            closeSpecificTicket(ticketId);
        }
        
        function closeSpecificTicket(ticketId) {
            if (!confirm(`Закрыть тикет ${ticketId}?`)) return;
            
            fetch(`/admin/close_ticket/${ticketId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            });
        }
    </script>
</body>
</html>